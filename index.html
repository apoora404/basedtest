<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Basedapp Simulator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <style>
    :root{
      color-scheme: dark light;
      --bg:#0e0f12; --panel:#16181d; --panel-solid:#121419; --border:#242833;
      --muted:#98a2af; --accent:#ff6a3d; --accent-2:#ff825c;
      --ok:#2ad7a3; --danger:#ff6b6b; --ring: 0 0 0 3px rgba(255,106,61,.35);
    }
    body{ background:var(--bg); color:#e8eaee }
    .card{ background:var(--panel); border:1px solid var(--border); }
    .muted{ color:var(--muted) }
    .btn{ background:var(--accent); color:white }
    .btn:hover{ filter:brightness(1.05) }
    .btn-ghost{ background:#1b1f26; border:1px solid var(--border); color:#e8eaee }
    input,select{
      background:#101217; border:1px solid var(--border); color:#e8eaee;
      border-radius:12px; padding:.65rem .8rem; width:100%;
    }
    input:focus,select:focus{ outline:none; box-shadow:var(--ring); border-color:#3a414b }
    .num{ font-variant-numeric:tabular-nums }
    .kv{ display:flex; gap:.5rem; align-items:baseline }
    .kv .k{ min-width:12.5rem; color:#aab2bd }
    .kv .v{ font-weight:700 }
    .fade-in { animation: fadeIn .28s ease-out both }
    @keyframes fadeIn { from { opacity:0; transform: translateY(6px) } to { opacity:1; transform: translateY(0) } }
    .text-ok{ color:var(--ok) !important }
    .text-danger{ color:var(--danger) !important }
  </style>
</head>
<body class="pb-28">
  <header class="max-w-5xl mx-auto px-4 py-7">
    <div class="rounded-3xl border border-[var(--accent)]/60 p-3 mx-auto w-fit">
      <div class="rounded-2xl px-5 py-3 bg-[var(--panel)] text-center">
        <h1 class="text-2xl font-semibold">Basedapp Simulator</h1>
      </div>
    </div>
    <p class="mt-3 muted text-sm leading-6">
        • <b>이전/현재 포인트만</b> 입력 시 → 포인트 차이로 <b>필요 거래량</b> 역산<br/>
        • <b>이전/현재 거래량만</b> 입력 시 → 거래량 차이로 <b>획득 XP</b> 계산<br/>
        • <b>총 수수료(누적)</b> 이전/현재를 넣으면 차이로 이번 구간 <b>총 수수료(리베이트 전)</b> 사용<br/>
        • 리베이트(60%)는 결과에서만 적용. <b>수수료 미입력 시 Taker 비중은 ‘—’</b>로 표시
    </p>
  </header>

  <main class="max-w-5xl mx-auto px-4 space-y-6">
    <section class="card rounded-2xl p-4">
      <div class="grid lg:grid-cols-2 gap-x-6 gap-y-4">
        
        <div class="space-y-4">
          <div class="grid sm:grid-cols-2 gap-3">
            <label class="block"><span class="block text-xs muted">이전 거래량 (누적, $)</span><input id="prevVol" type="number" step="0.01" placeholder="예: 0 또는 200000"></label>
            <label class="block"><span class="block text-xs muted">현재 거래량 (누적, $)</span><input id="currVol" type="number" step="0.01" placeholder="예: 10000 또는 290000"></label>
          </div>
          <div class="grid sm:grid-cols-2 gap-3">
            <label class="block"><span class="block text-xs muted">이전 포인트 (누적)</span><input id="prevPts" type="number" step="0.01" placeholder="예: 0 또는 12000"></label>
            <label class="block"><span class="block text-xs muted">현재 포인트 (누적)</span><input id="currPts" type="number" step="0.01" placeholder="예: 540 또는 20000"></label>
          </div>
          <details class="rounded-xl bg-[#101216] border border-[#2a2f36] p-3">
            <summary class="cursor-pointer select-none muted text-sm">▾ 고급 옵션: 총 수수료 직접 입력</summary>
            <div class="grid sm:grid-cols-2 gap-3 mt-3">
              <label class="block"><span class="block text-xs muted">이전 총 수수료 (누적, $)</span><input id="prevFeeGross" type="number" step="0.01" placeholder="예: 0 또는 25.3"></label>
              <label class="block"><span class="block text-xs muted">현재 총 수수료 (누적, $)</span><input id="currFeeGross" type="number" step="0.01" placeholder="예: 4.0 또는 409.1"></label>
            </div>
          </details>
          <div class="flex flex-wrap gap-2 pt-2">
            <button id="calc" class="btn px-4 py-2 rounded-xl font-semibold">계산하기</button>
            <button id="save" class="btn-ghost px-4 py-2 rounded-xl">입력값 저장</button>
            <button id="reset" class="btn-ghost px-4 py-2 rounded-xl">초기화</button>
          </div>
        </div>
        
        <div class="space-y-4">
          <label class="block"><span class="block text-xs muted">거래 방식</span><select id="mode"><option value="perps">선물 (Perps)</option><option value="spot">현물 (Spot)</option></select></label>
          <label class="block"><span class="block text-xs muted">XP 부스트</span><select id="boost"><option value="0">0%</option><option value="25">25%</option><option value="50">50%</option><option value="60" selected>60%</option></select></label>
          <label class="block"><span class="block text-xs muted">수수료 Tier (참고용)</span><select id="tier"></select><p class="text-[11px] muted mt-1" id="feeHint"></p></label>
          <div class="grid grid-cols-2 gap-3 pt-2 border-t border-[var(--border)]">
            <label class="block"><span class="block text-xs muted">시작 자금 ($)</span><input id="startCapital" type="number" step="0.01" placeholder="예: 1000"></label>
            <div id="leverageWrapper"><label class="block"><span class="block text-xs muted">레버리지</span><input id="leverage" type="number" value="1" step="1"></label></div>
          </div>
        </div>
      </div>
    </section>

    <section id="resultCard" class="card rounded-2xl p-4 fade-in">
        <div class="flex items-center gap-2 pr-32 relative">
            <h3 class="font-semibold text-lg">결과</h3>
            <span class="badge text-xs" id="modeBadge"></span>
            <span class="badge text-xs" id="feeBadge"></span>
            <div class="absolute right-0 top-0 flex gap-2">
                <button id="copy" class="btn-ghost px-3 py-1.5 rounded-lg text-sm">복사</button>
                <button id="saveImg" class="btn-ghost px-3 py-1.5 rounded-lg text-sm">PNG 저장</button>
            </div>
        </div>
        <div id="out" class="space-y-2 mt-3"></div>
    </section>
  </main>
  
  <script>
    const FEES = {
      perps: { tiers: [ { name: "Tier 0 (기본)", taker: 0.00045, maker: 0.00015 }, { name: "Tier 1 (>5M)", taker: 0.00040, maker: 0.00012 }, { name: "Tier 2 (>25M)", taker: 0.00035, maker: 0.00008 }, { name: "Tier 3 (>100M)", taker: 0.00030, maker: 0.00004 }, { name: "Tier 4 (>500M)", taker: 0.00028, maker: 0.00000 }, { name: "Tier 5 (>2B)", taker: 0.00026, maker: 0.00000 }, { name: "Tier 6 (>7B)", taker: 0.00024, maker: 0.00000 } ]},
      spot: { tiers: [ { name: "Tier 0 (기본)", taker: 0.00070, maker: 0.00040 }, { name: "Tier 1 (>5M)", taker: 0.00060, maker: 0.00030 }, { name: "Tier 2 (>25M)", taker: 0.00050, maker: 0.00020 }, { name: "Tier 3 (>100M)", taker: 0.00040, maker: 0.00010 }, { name: "Tier 4 (>500M)", taker: 0.00035, maker: 0.00000 }, { name: "Tier 5 (>2B)", taker: 0.00030, maker: 0.00000 }, { name: "Tier 6 (>7B)", taker: 0.00025, maker: 0.00000 } ]},
    };
    const XP_PER_DOLLAR_BASE = { perps: 0.03375, spot: 0.1266 };
    const xpPerDollar = (mode, boostPct) => (XP_PER_DOLLAR_BASE[mode] || 0) * (1 + (boostPct || 0) / 100);

    const $ = (id) => document.getElementById(id);
    const d2 = (n) => Number(n || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    const d4 = (n) => Number(n || 0).toLocaleString(undefined, { minimumFractionDigits: 4, maximumFractionDigits: 4 });

    function populateTier() {
        const mode = $("mode").value, sel = $("tier"); sel.innerHTML = "";
        FEES[mode].tiers.forEach((t, i) => { const o = document.createElement("option"); o.value = i; o.textContent = t.name; sel.appendChild(o); });
        sel.value = 0; updateFeeHint();
    }

    function updateFeeHint() {
        const mode = $("mode").value, t = FEES[mode].tiers[Number($("tier").value)];
        $("feeHint").textContent = `Taker ${(t.taker * 100).toFixed(3)}% · Maker ${(t.maker * 100).toFixed(3)}%`;
        $("feeBadge").textContent = `Maker/Taker: ${(t.maker*100).toFixed(3)}% / ${(t.taker*100).toFixed(3)}%`;
        $("modeBadge").textContent = `${mode==='perps'?'Perps':'Spot'} · ${t.name}`;
    }

    let _lastResult = null;

    function compute() {
        let hasError = false;
        const numericInputIds = ["prevVol", "currVol", "prevPts", "currPts", "prevFeeGross", "currFeeGross", "startCapital", "leverage"];
        numericInputIds.forEach(id => {
            const input = $(id);
            if (input && Number(input.value) < 0) {
                input.style.borderColor = 'var(--danger)'; hasError = true;
            } else if (input) {
                input.style.borderColor = 'var(--border)';
            }
        });
        if (hasError) { $("out").innerHTML = `<div class="text-sm text-[var(--danger)]">입력값에 음수가 포함될 수 없습니다.</div>`; return; }
        
        const mode = $("mode").value;
        const tierIdx = Number($("tier").value);
        const fee = FEES[mode].tiers[tierIdx];
        const makerFee = fee.maker, takerFee = fee.taker;
        const boost = Number($("boost").value || 0);

        const startCapital = Number($("startCapital").value || 0);
        const leverage = mode === 'perps' ? Number($("leverage").value || 1) : 1;
        const prevVol = Number($("prevVol").value || 0);
        const currVol = Number($("currVol").value || 0);
        const prevPts = Number($("prevPts").value || 0);
        const currPts = Number($("currPts").value || 0);
        const prevFeeGross = Number($("prevFeeGross").value || 0);
        const currFeeGross = Number($("currFeeGross").value || 0);

        const deltaVol = Math.max(0, currVol - prevVol);
        const deltaPts = Math.max(0, currPts - prevPts);
        const eff = xpPerDollar(mode, boost);

        let usedVol = 0, usedPts = 0;
        if (deltaVol > 0) {
            usedVol = deltaVol;
            usedPts = (deltaPts > 0) ? deltaPts : usedVol * eff;
        } else if (deltaPts > 0) {
            usedPts = deltaPts;
            usedVol = eff > 0 ? usedPts / eff : 0;
        } else {
            $("out").innerHTML = `<div class="text-sm muted">포인트 또는 거래량 중 하나를 입력해 주세요.</div>`;
            _lastResult = null; return;
        }

        let tradeCountText = "—";
        if (startCapital > 0 && usedVol > 0) {
            tradeCountText = `${d2(usedVol / (startCapital * leverage))} 회`;
        }

        let feeGross = usedVol * makerFee;
        const feeGrossInput = Math.max(0, currFeeGross - prevFeeGross);
        const feeByUser = feeGrossInput > 0;
        if (feeByUser) feeGross = feeGrossInput;

        const avgFeeRate = usedVol > 0 ? (feeGross / usedVol) : 0;
        let takerShareText = "—";
        if (feeByUser && usedVol > 0 && takerFee !== makerFee) {
            const share = Math.min(1, Math.max(0, (avgFeeRate - makerFee) / (takerFee - makerFee)));
            takerShareText = `${d2(share * 100)} %`;
        }
        
        const rebateRate = 0.60, rebateAmt = feeGross * rebateRate, feeNet = feeGross - rebateAmt;
        const xpEfficiency = usedVol > 0 ? usedPts / usedVol : 0;
        const volPerXp = usedPts > 0 ? usedVol / usedPts : 0;

        const rows = [];
        rows.push(`<div class="kv"><span class="k">사용 거래량</span><span class="v num text-[1.05rem]">${d2(usedVol)} $</span></div>`);
        rows.push(`<div class="kv"><span class="k">추정 거래 횟수</span><span class="v num">${tradeCountText}</span></div>`);
        rows.push(`<div class="kv"><span class="k">획득 XP</span><span class="v num text-[1.05rem]">${d2(usedPts)} XP</span></div>`);
        rows.push(`<hr class="my-3 border-[#2b2f36]" />`);
        rows.push(`<div class="kv"><span class="k">총 수수료(리베이트 전)</span><span class="v num">${d2(feeGross)} $</span></div>`);
        rows.push(`<div class="kv"><span class="k">추정 Taker 비중</span><span class="v num">${takerShareText}</span></div>`);
        rows.push(`<div class="kv"><span class="k">셀프레퍼럴 수익(60%)</span><span class="v num" style="color:var(--ok)">${d2(rebateAmt)} $</span></div>`);
        rows.push(`<div class="kv"><span class="k">실제 낸 수수료</span><span class="v num" style="color:var(--danger)">${d2(feeNet)} $</span></div>`);
        const costPerXp = usedPts > 0 ? (feeNet / usedPts) : 0;
        rows.push(`<div class="kv"><span class="k">1 XP당 실질 비용</span><span class="v num">${d4(costPerXp)} $/XP</span></div>`);

        $("out").innerHTML = `<div class="space-y-1 fade-in">${rows.join("")}</div>`;

        _lastResult = { /* ... (기존과 동일) ... */ };
        updateFeeHint();
    }
    
    // ... (copyResultToClipboard, saveResultAsPng 함수는 기존과 동일) ...

    const KEYS = ["mode", "boost", "tier", "prevVol", "currVol", "prevPts", "currPts", "prevFeeGross", "currFeeGross", "startCapital", "leverage"];

    function saveInputs() {
        const obj = {};
        KEYS.forEach(k => { if ($(k)) obj[k] = $(k).value });
        localStorage.setItem("basedapp_Simulator_v2", JSON.stringify(obj));
    }

    function loadInputs() {
        const raw = localStorage.getItem("basedapp_Simulator_v2");
        if (!raw) return;
        try {
            const obj = JSON.parse(raw);
            KEYS.forEach(k => { if ($(k) && obj[k] !== undefined) $(k).value = obj[k]; });
            populateTier();
            updateFeeHint();
        } catch (e) {}
    }
    
    function resetAll() {
        KEYS.forEach(k => { if ($(k) && k !== 'boost' && k !== 'mode') $(k).value = ""; });
        $("boost").value = "60"; $("mode").value = "perps";
        populateTier(); updateFeeHint();
        $("out").innerHTML = ""; _lastResult = null;
        toggleLeverage();
    }
    
    function toggleLeverage() {
        $('leverageWrapper').style.display = $('mode').value === 'perps' ? 'block' : 'none';
    }

    document.addEventListener('DOMContentLoaded', () => {
        populateTier();
        loadInputs();
        toggleLeverage();
        
        $('calc').addEventListener('click', compute);
        $('save').addEventListener('click', () => { saveInputs(); /* ... */ });
        $('reset').addEventListener('click', resetAll);

        $('mode').addEventListener('change', () => {
            populateTier();
            toggleLeverage();
        });
        $('tier').addEventListener('change', updateFeeHint);

        KEYS.forEach(id => {
            const el = $(id);
            if (el) { el.addEventListener('input', compute); }
        });

        compute();
    });
  </script>
</body>
</html>
