<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Basedapp Simulator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <style>
    :root{
      color-scheme: dark light;
      --bg:#0e0f12; --panel:#16181d; --panel-solid:#121419; --border:#242833;
      --muted:#98a2af; --accent:#ff6a3d; --accent-2:#ff825c;
      --ok:#2ad7a3; --danger:#ff6b6b; --ring: 0 0 0 3px rgba(255,106,61,.35);
    }
    body{ background:var(--bg); color:#e8eaee }
    .card{ background:var(--panel); border:1px solid var(--border) }
    .muted{ color:var(--muted) }
    .btn-accent{ background:var(--accent); color:white }
    .btn-accent:hover{ filter:brightness(1.05) }
    .btn-ghost{ background:#1b1f26; border:1px solid var(--border); color:#e8eaee }
    input,select{
      background:#101217; border:1px solid var(--border); color:#e8eaee;
      border-radius:12px; padding:.65rem .8rem; width:100%;
    }
    input:focus,select:focus{ outline:none; box-shadow:var(--ring); border-color:#3a414b }
    .num{ font-variant-numeric:tabular-nums }
    .kv{ display:flex; gap:.5rem; align-items:baseline }
    .kv .k{ min-width:12.5rem; color:#aab2bd }
    .kv .v{ font-weight:700 }
    .fade-in { animation: fadeIn .28s ease-out both }
    @keyframes fadeIn { from { opacity:0; transform: translateY(6px) } to { opacity:1; transform: translateY(0) } }
    
    /* 신규 UI 스타일 */
    .tab{ padding: .5rem 1rem; border-bottom: 2px solid transparent; color: var(--muted); cursor: pointer; transition: color .2s, border-color .2s; }
    .tab.active{ color: var(--accent); border-bottom-color: var(--accent); font-weight: 600; }
    .sim-label{ display:flex; justify-content:space-between; align-items:center; }
  </style>
</head>
<body class="pb-28">
  <header class="max-w-5xl mx-auto px-4 py-7">
    <div class="rounded-3xl border border-[var(--accent)]/60 p-3 mx-auto w-fit">
      <div class="rounded-2xl px-5 py-3 bg-[var(--panel)] text-center">
        <h1 class="text-2xl font-semibold">Basedapp Simulator</h1>
      </div>
    </div>
  </header>

  <main class="max-w-5xl mx-auto px-4 space-y-6">
    <section class="card rounded-2xl overflow-hidden md:flex">
      <div class="p-4 md:w-1/3 md:border-r md:border-[var(--border)]">
        <h3 class="font-semibold mb-3 text-lg">기본 설정</h3>
        <div class="space-y-4">
          <label class="block" for="boost">
            <span class="block text-xs muted mb-1">XP 부스트</span>
            <select id="boost">
              <option value="0">0%</option> <option value="25">25%</option> <option value="50">50%</option> <option value="60" selected>60%</option>
            </select>
          </label>
          <label class="block" for="tier">
            <span class="block text-xs muted mb-1">14일 가중 거래량 Tier</span>
            <select id="tier"></select>
            <p class="text-[11px] muted mt-1" id="feeHint"></p>
          </label>
        </div>
      </div>

      <div class="p-4 md:flex-grow">
        <div class="flex border-b border-[var(--border)]">
          <button id="tabPerps" class="tab active">선물 (Perps)</button>
          <button id="tabSpot" class="tab">현물 (Spot)</button>
        </div>
        
        <div class="space-y-4 mt-4">
          <label class="block">
            <span class="sim-label text-xs muted mb-1"><span>시작 자금</span> <span>Available: $<span id="capitalDisplay">0.00</span></span></span>
            <input id="startCapital" type="number" step="0.01" placeholder="1000">
          </label>

          <div id="leverageWrapper">
             <label class="block">
              <span class="sim-label text-xs muted mb-1"><span>레버리지</span> <span>최대 50x</span></span>
              <input id="leverage" type="number" step="1" value="10" placeholder="10">
            </label>
          </div>
          
          <label class="block">
            <span class="sim-label text-xs muted mb-1"><span>1회 포지션 크기 ($)</span><span id="effectiveCapitalDisplay" class="text-xs muted"></span></span>
            <input id="positionSize" type="number" step="0.01" placeholder="10000">
          </label>
          
          <label class="block">
            <span class="sim-label text-xs muted mb-1"><span>거래 횟수</span><span id="totalVolumeDisplay" class="text-xs muted"></span></span>
            <input id="tradeCount" type="number" step="1" placeholder="100">
          </label>

          <button id="simulateBtn" class="w-full btn-accent p-3 rounded-xl font-bold text-lg mt-2">
            결과 계산하기
          </button>
        </div>
      </div>
    </section>

    <details class="card rounded-2xl p-4">
      <summary class="cursor-pointer select-none muted text-sm">▾ 이전/현재 값으로 직접 계산하기 (상세 모드)</summary>
      <div id="legacy-wrapper" class="mt-4 space-y-4">
          </div>
    </details>

    <section id="resultCard" class="card rounded-2xl p-4 fade-in">
      <div class="flex items-center gap-2 pr-32 relative">
        <h3 class="font-semibold text-lg">결과</h3>
        <span class="badge text-xs" id="modeBadge"></span>
        <span class="badge text-xs" id="feeBadge"></span>
        <div class="absolute right-0 top-0 flex gap-2">
          <button id="copy" class="btn-ghost px-3 py-1.5 rounded-lg text-sm">복사</button>
          <button id="saveImg" class="btn-ghost px-3 py-1.5 rounded-lg text-sm">PNG 저장</button>
        </div>
      </div>
      <div id="out" class="space-y-2 mt-3"></div>
      <p class="text-[11px] muted mt-3">
        평균 수수료율은 기본적으로 <b>Maker</b>만 가정합니다. 상세 모드에서 총 수수료(누적 차이)를 입력하면 평균 수수료율과 <b>추정 Taker 비중</b>을 역산하여 참고로 제공합니다.
      </p>
    </section>
  </main>
  
  <footer class="mt-6 py-4 border-t border-[var(--border)] text-center text-sm text-[var(--muted)]">
    Brought to you by <a href="https://twitter.com/no_gongju" target="_blank" rel="noopener" class="ml-1 text-[var(--accent)] hover:underline">@no_gongju</a>
  </footer>

  <script>
    // --- 설정 및 상수 ---
    const FEES = {
      perps: { tiers: [
        { name: "Tier 0 (기본)", taker: 0.00045, maker: 0.00015 }, { name: "Tier 1 (>5M)", taker: 0.00040, maker: 0.00012 }, { name: "Tier 2 (>25M)", taker: 0.00035, maker: 0.00008 }, { name: "Tier 3 (>100M)", taker: 0.00030, maker: 0.00004 }, { name: "Tier 4 (>500M)", taker: 0.00028, maker: 0.00000 }, { name: "Tier 5 (>2B)", taker: 0.00026, maker: 0.00000 }, { name: "Tier 6 (>7B)", taker: 0.00024, maker: 0.00000 },
      ]},
      spot: { tiers: [
        { name: "Tier 0 (기본)", taker: 0.00070, maker: 0.00040 }, { name: "Tier 1 (>5M)", taker: 0.00060, maker: 0.00030 }, { name: "Tier 2 (>25M)", taker: 0.00050, maker: 0.00020 }, { name: "Tier 3 (>100M)", taker: 0.00040, maker: 0.00010 }, { name: "Tier 4 (>500M)", taker: 0.00035, maker: 0.00000 }, { name: "Tier 5 (>2B)", taker: 0.00030, maker: 0.00000 }, { name: "Tier 6 (>7B)", taker: 0.00025, maker: 0.00000 },
      ]},
    };
    const XP_PER_DOLLAR_BASE = { perps: 0.03375, spot: 0.1266 };
    const $ = (id) => document.getElementById(id);
    const d2 = (n) => Number(n || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    const d4 = (n) => Number(n || 0).toLocaleString(undefined, { minimumFractionDigits: 4, maximumFractionDigits: 4 });
    const xpPerDollar = (mode, boostPct) => (XP_PER_DOLLAR_BASE[mode] || 0) * (1 + (boostPct || 0) / 100);
    
    let _lastResultHtml = '';
    let currentMode = 'perps';

    // --- 핵심 계산 로직 ---
    function calculateResults(params) {
      _lastResultHtml = '';
      const { usedVol, tradeCount, mode, tierIdx, boost } = params;
      
      if (usedVol <= 0) {
        return `<div class="text-sm muted">계산을 위한 거래량이 없습니다. 시뮬레이터나 상세 모드에서 값을 입력해주세요.</div>`;
      }

      const fee = FEES[mode].tiers[tierIdx];
      const makerFee = fee.maker, takerFee = fee.taker;
      const eff = xpPerDollar(mode, boost);
      const usedPts = usedVol * eff;

      let feeGross = usedVol * makerFee; // 기본 Maker 가정
      let avgFeeRate = makerFee;
      let takerShareText = "— (상세 모드 입력 필요)";
      
      if (params.feeGrossInput > 0) {
        feeGross = params.feeGrossInput;
        avgFeeRate = usedVol > 0 ? (feeGross / usedVol) : 0;
        if (usedVol > 0 && takerFee !== makerFee) {
            const share = Math.min(1, Math.max(0, (avgFeeRate - makerFee) / (takerFee - makerFee)));
            takerShareText = `${d2(share * 100)} %`;
        }
      }

      const rebateRate = 0.60, rebateAmt = feeGross * rebateRate, feeNet = feeGross - rebateAmt;
      const costPerXp = usedPts > 0 ? (feeNet / usedPts) : 0;

      const oppositeMode = (mode === 'perps') ? 'spot' : 'perps';
      const oppositeModeName = (oppositeMode === 'spot') ? '현물' : '선물';
      const oppositeFee = FEES[oppositeMode].tiers[tierIdx];
      const oppositeEff = xpPerDollar(oppositeMode, boost);
      const whatIfPts = usedVol * oppositeEff;
      const whatIfFeeNet = (usedVol * oppositeFee.maker) * (1 - rebateRate);
      const whatIfCostPerXp = whatIfPts > 0 ? (whatIfFeeNet / whatIfPts) : 0;

      const rows = [
        `<div class="kv"><span class="k">총 거래량</span><span class="v num text-[1.05rem]">${d2(usedVol)} $</span></div>`,
        `<div class="kv"><span class="k">거래 횟수</span><span class="v num">${tradeCount ? d2(tradeCount) + ' 회' : '—'}</span></div>`,
        `<div class="kv"><span class="k">예상 획득 XP</span><span class="v num text-[1.05rem]">${d2(usedPts)} XP</span></div>`,
        `<hr class="my-3 border-[#2b2f36]" />`,
        `<div class="kv"><span class="k">총 수수료 (Maker 기준)</span><span class="v num">${d2(feeGross)} $</span></div>`,
        `<div class="kv"><span class="k">추정 Taker 비중</span><span class="v num">${takerShareText}</span></div>`,
        `<div class="kv"><span class="k">셀프레퍼럴 수익(60%)</span><span class="v num text-[var(--ok)]">${d2(rebateAmt)} $</span></div>`,
        `<div class="kv"><span class="k">실제 낸 수수료 (리베이트 후)</span><span class="v num text-[var(--danger)]">${d2(feeNet)} $</span></div>`,
        `<div class="kv"><span class="k">1 XP당 실질 비용</span><span class="v num">${d4(costPerXp)} $/XP</span></div>`,
        `<hr class="my-3 border-[#2b2f36]" />`,
        `<div class="text-sm muted mb-2">만약 동일 거래량을 <b class="text-white">${oppositeModeName}</b>(으)로 했다면? (Maker 기준)</div>`,
        `<div class="kv"><span class="k">예상 획득 XP</span><span class="v num">${d2(whatIfPts)} XP</span></div>`,
        `<div class="kv"><span class="k">예상 실제 수수료</span><span class="v num text-[var(--danger)]">${d2(whatIfFeeNet)} $</span></div>`,
        `<div class="kv"><span class="k">예상 1 XP당 비용</span><span class="v num">${d4(whatIfCostPerXp)} $/XP</span></div>`,
      ];
      
      const resultHtml = `<div class="space-y-1">${rows.join("")}</div>`;
      _lastResultHtml = resultHtml; // 결과를 전역 변수에 저장
      return resultHtml;
    }

    // --- UI 업데이트 및 이벤트 핸들러 ---
    function updateFeeHint() {
      const tierIdx = Number($("tier").value);
      const t = FEES[currentMode].tiers[tierIdx];
      $("feeHint").textContent = `Taker ${(t.taker*100).toFixed(3)}% · Maker ${(t.maker*100).toFixed(3)}%`;
      $("modeBadge").textContent = `${currentMode === 'perps' ? 'Perps' : 'Spot'} · ${t.name}`;
      $("feeBadge").textContent = `Maker/Taker: ${(t.maker*100).toFixed(3)}% / ${(t.taker*100).toFixed(3)}%`;
    }

    function populateTier() {
      const sel = $("tier");
      const currentTier = sel.value;
      sel.innerHTML = "";
      FEES[currentMode].tiers.forEach((t, i) => {
        const o = document.createElement("option");
        o.value = i; o.textContent = t.name; sel.appendChild(o);
      });
      sel.value = currentTier || 0;
      updateFeeHint();
    }

    function switchMode(mode) {
        currentMode = mode;
        $('tabPerps').classList.toggle('active', mode === 'perps');
        $('tabSpot').classList.toggle('active', mode === 'spot');
        $('leverageWrapper').style.display = mode === 'perps' ? 'block' : 'none';
        populateTier();
    }
    
    function updateSimulatorDisplays() {
        const capital = Number($('startCapital').value || 0);
        const leverage = currentMode === 'perps' ? Number($('leverage').value || 1) : 1;
        const posSize = Number($('positionSize').value || 0);
        const tradeCount = Number($('tradeCount').value || 0);

        $('capitalDisplay').textContent = d2(capital);
        $('effectiveCapitalDisplay').textContent = `실질 자금: $${d2(capital * leverage)}`;
        $('totalVolumeDisplay').textContent = `총 거래량: $${d2(posSize * tradeCount)}`;
    }

    // --- 계산 실행 함수 ---
    function runSimulation() {
        const params = {
            usedVol: Number($('positionSize').value || 0) * Number($('tradeCount').value || 0),
            tradeCount: Number($('tradeCount').value || 0),
            mode: currentMode,
            tierIdx: Number($('tier').value),
            boost: Number($('boost').value),
            feeGrossInput: 0
        };
        $('out').innerHTML = calculateResults(params);
    }

    function runLegacyCalculation() {
        const prevVol = Number($("prevVol").value || 0), currVol = Number($("currVol").value || 0);
        const prevPts = Number($("prevPts").value || 0), currPts = Number($("currPts").value || 0);
        const prevFee = Number($("prevFeeGross").value || 0), currFee = Number($("currFeeGross").value || 0);

        const deltaVol = Math.max(0, currVol - prevVol);
        const deltaPts = Math.max(0, currPts - prevPts);
        const eff = xpPerDollar(currentMode, Number($('boost').value));
        
        let usedVol = 0;
        if (deltaVol > 0) usedVol = deltaVol;
        else if (deltaPts > 0 && eff > 0) usedVol = deltaPts / eff;

        const params = {
            usedVol: usedVol,
            tradeCount: null,
            mode: currentMode,
            tierIdx: Number($('tier').value),
            boost: Number($('boost').value),
            feeGrossInput: Math.max(0, currFee - prevFee)
        };
        $('out').innerHTML = calculateResults(params);
    }
    
    function createLegacyInputs() {
        const wrapper = $('legacy-wrapper');
        const fields = [
            { id: 'prevVol', label: '이전 거래량 (누적, $)' }, { id: 'currVol', label: '현재 거래량 (누적, $)' },
            { id: 'prevPts', label: '이전 포인트 (누적)' }, { id: 'currPts', label: '현재 포인트 (누적)' },
            { id: 'prevFeeGross', label: '이전 총 수수료 (누적, $)' }, { id: 'currFeeGross', label: '현재 총 수수료 (누적, $)' },
        ];
        
        let html = '<div class="grid sm:grid-cols-2 gap-3">';
        fields.forEach((field, i) => {
            html += `
                <label class="block">
                    <span class="block text-xs muted">${field.label}</span>
                    <input id="${field.id}" type="number" step="0.01" />
                </label>
            `;
            if (i % 2 !== 0 && i < fields.length - 1) {
                html += '</div><div class="grid sm:grid-cols-2 gap-3 mt-3">';
            }
        });
        html += '</div><button id="legacyCalcBtn" class="btn-accent px-4 py-2 rounded-xl font-semibold mt-4">상세 모드로 계산</button>';
        wrapper.innerHTML = html;
        $('legacyCalcBtn').addEventListener('click', runLegacyCalculation);
    }
    
    async function saveResultAsPng() {
        // (PNG 저장 기능은 이전 코드를 참고하여 이 _lastResultHtml 변수를 사용하도록 수정해야 합니다.)
        alert('PNG 저장 기능은 이 새 버전에 맞게 업데이트가 필요합니다.');
    }

    function copyResultToClipboard() {
        // (클립보드 복사 기능도 새 결과 포맷에 맞게 업데이트가 필요합니다.)
        alert('클립보드 복사 기능은 이 새 버전에 맞게 업데이트가 필요합니다.');
    }

    // --- 초기화 및 이벤트 바인딩 ---
    document.addEventListener('DOMContentLoaded', () => {
        $('tabPerps').addEventListener('click', () => switchMode('perps'));
        $('tabSpot').addEventListener('click', () => switchMode('spot'));
        
        ['startCapital', 'leverage', 'positionSize', 'tradeCount'].forEach(id => {
            $(id).addEventListener('input', updateSimulatorDisplays);
        });
        $('simulateBtn').addEventListener('click', runSimulation);

        ['boost', 'tier'].forEach(id => {
            $(id).addEventListener('change', () => {
                updateFeeHint();
                runSimulation(); // 설정 변경 시 결과 자동 업데이트
            });
        });

        $('copy').addEventListener('click', copyResultToClipboard);
        $('saveImg').addEventListener('click', saveResultAsPng);

        createLegacyInputs();
        switchMode('perps');
        populateTier();
        updateSimulatorDisplays();
        $('out').innerHTML = `<div class="text-sm muted">시뮬레이터에 값을 입력하고 '결과 계산하기' 버튼을 눌러주세요.</div>`;
    });
  </script>
</body>
</html>