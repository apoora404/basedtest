<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Basedapp Simulator (v3)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <style>
    :root{
      color-scheme: dark light;
      --bg:#0e0f12; --panel:#16181d; --panel-solid:#121419; --border:#242833;
      --muted:#98a2af; --accent:#ff6a3d; --accent-2:#ff825c;
      --ok:#2ad7a3; --danger:#ff6b6b; --ring: 0 0 0 3px rgba(255,106,61,.35);
    }
    body{ background:var(--bg); color:#e8eaee }
    .card{ background:var(--panel); border:1px solid var(--border); height: 100%; }
    .muted{ color:var(--muted) }
    .btn-accent{ background:var(--accent); color:white }
    .btn-accent:hover{ filter:brightness(1.05) }
    .btn-ghost{ background:#1b1f26; border:1px solid var(--border); color:#e8eaee }
    input,select{
      background:#101217; border:1px solid var(--border); color:#e8eaee;
      border-radius:12px; padding:.65rem .8rem; width:100%;
    }
    input:focus,select:focus{ outline:none; box-shadow:var(--ring); border-color:#3a414b }
    .num{ font-variant-numeric:tabular-nums }
    .kv{ display:flex; gap:.5rem; align-items:baseline }
    .kv .k{ min-width:12.5rem; color:#aab2bd }
    .kv .v{ font-weight:700 }
    .fade-in { animation: fadeIn .28s ease-out both }
    @keyframes fadeIn { from { opacity:0; transform: translateY(6px) } to { opacity:1; transform: translateY(0) } }
    
    .tab{ padding: .5rem 1rem; border-bottom: 2px solid transparent; color: var(--muted); cursor: pointer; transition: color .2s, border-color .2s; }
    .tab.active{ color: var(--accent); border-bottom-color: var(--accent); font-weight: 600; }
    .sim-label{ display:flex; justify-content:space-between; align-items:center; }
  </style>
</head>
<body class="pb-28">
  <header class="max-w-7xl mx-auto px-4 py-7">
    <div class="rounded-3xl border border-[var(--accent)]/60 p-3 mx-auto w-fit">
      <div class="rounded-2xl px-5 py-3 bg-[var(--panel)] text-center">
        <h1 class="text-2xl font-semibold">Basedapp Simulator</h1>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 space-y-6">
    <div class="grid lg:grid-cols-3 gap-6">
        <div class="card rounded-2xl p-4 lg:col-span-1">
            <h3 class="font-semibold mb-3 text-lg">시뮬레이터</h3>
            <div class="space-y-4 mt-4">
                <label class="block">
                    <span class="sim-label text-xs muted mb-1"><span>1회 포지션 크기 ($)</span></span>
                    <input id="positionSize" type="number" step="0.01" placeholder="10000">
                </label>
                <label class="block">
                    <span class="sim-label text-xs muted mb-1"><span>거래 횟수 (매수+매도=1회)</span><span id="totalVolumeDisplay" class="text-xs muted"></span></span>
                    <input id="tradeCount" type="number" step="1" placeholder="100">
                </label>
                <button id="simulateBtn" class="w-full btn-accent p-3 rounded-xl font-bold text-lg mt-2">
                    결과 계산하기
                </button>
            </div>
        </div>

        <div class="card rounded-2xl p-4 lg:col-span-1">
            <h3 class="font-semibold mb-3 text-lg">상세 모드 (직접 계산)</h3>
            <div id="legacy-wrapper" class="mt-4 space-y-4">
                </div>
        </div>
        
        <div class="card rounded-2xl p-4 lg:col-span-1">
            <h3 class="font-semibold mb-3 text-lg">기본 설정</h3>
            <div class="flex border-b border-[var(--border)] mb-4">
                <button id="tabPerps" class="tab active">선물</button>
                <button id="tabSpot" class="tab">현물</button>
            </div>
            <div class="space-y-4">
                <label class="block">
                    <span class="sim-label text-xs muted mb-1"><span>시작 자금 ($)</span> <span>Available: $<span id="capitalDisplay">0.00</span></span></span>
                    <input id="startCapital" type="number" step="0.01" placeholder="1000">
                </label>
                <div id="leverageWrapper">
                    <label class="block">
                        <span class="sim-label text-xs muted mb-1"><span>레버리지</span> <span>Buying Power: $<span id="buyingPowerDisplay">0.00</span></span></span>
                        <input id="leverage" type="number" step="1" value="10" placeholder="10">
                    </label>
                </div>
            </div>
        </div>
    </div>

    <section id="resultCard" class="card rounded-2xl p-4 fade-in">
      <div class="flex items-center gap-2 pr-32 relative">
        <h3 class="font-semibold text-lg">결과</h3>
        <span class="badge text-xs" id="modeBadge"></span>
        <div class="absolute right-0 top-0 flex gap-2">
          <button id="copy" class="btn-ghost px-3 py-1.5 rounded-lg text-sm">복사</button>
          <button id="saveImg" class="btn-ghost px-3 py-1.5 rounded-lg text-sm">PNG 저장</button>
        </div>
      </div>
      <div id="out" class="space-y-2 mt-3"></div>
      <p class="text-[11px] muted mt-3">
        ※ 현물(Spot)의 XP와 수수료는 매수/매도 비중을 50:50으로 가정한 평균값입니다.
      </p>
    </section>
  </main>
  
  <footer class="mt-6 py-4 border-t border-[var(--border)] text-center text-sm text-[var(--muted)]">
    Brought to you by <a href="https://twitter.com/no_gongju" target="_blank" rel="noopener" class="ml-1 text-[var(--accent)] hover:underline">@no_gongju</a>
  </footer>

  <script>
    const NEW_FEES = {
        perps: { maker_total: 0.0004, builder_fee: 0.00025 },
        spot: { maker_total_avg: 0.0009, builder_fee_avg: 0.0005 }
    };
    const XP_PER_BUILDER_FEE = 1;

    const $ = (id) => document.getElementById(id);
    const d2 = (n) => Number(n || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    const d4 = (n) => Number(n || 0).toLocaleString(undefined, { minimumFractionDigits: 4, maximumFractionDigits: 4 });
    
    let currentMode = 'perps';

    function calculateResults(params) {
      const { usedVol } = params;
      
      if (usedVol <= 0) {
        return `<div class="text-sm muted">시뮬레이터 또는 상세 모드에 값을 입력하고 계산 버튼을 눌러주세요.</div>`;
      }

      let builderFeePaid, totalFeePaid, xpEarned;
      if (currentMode === 'perps') {
          builderFeePaid = usedVol * NEW_FEES.perps.builder_fee;
          totalFeePaid = usedVol * NEW_FEES.perps.maker_total;
      } else {
          builderFeePaid = usedVol * NEW_FEES.spot.builder_fee_avg;
          totalFeePaid = usedVol * NEW_FEES.spot.maker_total_avg;
      }
      xpEarned = builderFeePaid * XP_PER_BUILDER_FEE;

      const rebateRate = 0.60;
      const totalFeeBeforeRebate = totalFeePaid;
      const rebateAmt = totalFeeBeforeRebate * rebateRate;
      const netFeePaid = totalFeeBeforeRebate - rebateAmt;
      const costPerXp = xpEarned > 0 ? (netFeePaid / xpEarned) : 0;
      const xpPer1kVol = usedVol > 0 ? (xpEarned / (usedVol / 1000)) : 0;

      const rows = [
        `<div class="kv"><span class="k">총 거래량</span><span class="v num text-[1.05rem]">${d2(usedVol)} $</span></div>`,
        `<div class="kv"><span class="k">예상 획득 XP</span><span class="v num text-[1.05rem]">${d2(xpEarned)} XP</span></div>`,
        `<div class="kv"><span class="k">1k 거래량 당 XP</span><span class="v num">${d2(xpPer1kVol)}</span></div>`,
        `<hr class="my-3 border-[#2b2f36]" />`,
        `<div class="kv"><span class="k">총 수수료 (리베이트 전)</span><span class="v num">${d2(totalFeeBeforeRebate)} $</span></div>`,
        `<div class="kv"><span class="k">셀프레퍼럴 수익 (60%)</span><span class="v num text-[var(--ok)]">${d2(rebateAmt)} $</span></div>`,
        `<div class="kv"><span class="k">실제 낸 수수료 (리베이트 후)</span><span class="v num text-[var(--danger)]">${d2(netFeePaid)} $</span></div>`,
        `<div class="kv"><span class="k">1 XP당 실질 비용</span><span class="v num text-[var(--danger)]">${d4(costPerXp)} $</span></div>`,
      ];
      
      return `<div class="space-y-1">${rows.join("")}</div>`;
    }

    function updateModeBadge() {
        const modeName = currentMode === 'perps' ? '선물 (Perps)' : '현물 (Spot)';
        $('modeBadge').textContent = modeName;
    }

    function switchMode(mode) {
        currentMode = mode;
        $('tabPerps').classList.toggle('active', mode === 'perps');
        $('tabSpot').classList.toggle('active', mode === 'spot');
        $('leverageWrapper').style.display = mode === 'perps' ? 'block' : 'none';
        updateModeBadge();
    }
    
    function updateSimulatorDisplays() {
        const capital = Number($('startCapital').value || 0);
        const leverage = currentMode === 'perps' ? Number($('leverage').value || 1) : 1;
        const posSize = Number($('positionSize').value || 0);
        const tradeCount = Number($('tradeCount').value || 0);

        $('capitalDisplay').textContent = d2(capital);
        $('buyingPowerDisplay').textContent = d2(capital * leverage);
        $('totalVolumeDisplay').textContent = `총 거래량: $${d2(posSize * tradeCount)}`;
    }

    function runSimulation() {
        const positionSize = Number($('positionSize').value || 0);
        const tradeCount = Number($('tradeCount').value || 0);
        const params = { usedVol: positionSize * tradeCount };
        $('out').innerHTML = calculateResults(params);
    }

    function runLegacyCalculation() {
        const prevVol = Number($("prevVol").value || 0), currVol = Number($("currVol").value || 0);
        let usedVol = Math.max(0, currVol - prevVol);
        const params = { usedVol: usedVol };
        $('out').innerHTML = calculateResults(params);
    }
    
    function createLegacyInputs() {
        const wrapper = $('legacy-wrapper');
        const fields = [
            { id: 'prevVol', label: '이전 거래량 (누적, $)' }, 
            { id: 'currVol', label: '현재 거래량 (누적, $)' },
        ];
        
        let html = '<div class="space-y-4">';
        fields.forEach(field => {
            html += `
                <label class="block">
                    <span class="block text-xs muted">${field.label}</span>
                    <input id="${field.id}" type="number" step="0.01" />
                </label>
            `;
        });
        html += '</div><button id="legacyCalcBtn" class="btn-accent px-4 py-2 rounded-xl font-semibold w-full mt-4">상세 모드로 계산</button>';
        wrapper.innerHTML = html;
        $('legacyCalcBtn').addEventListener('click', runLegacyCalculation);
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        $('tabPerps').addEventListener('click', () => switchMode('perps'));
        $('tabSpot').addEventListener('click', () => switchMode('spot'));
        
        ['startCapital', 'leverage', 'positionSize', 'tradeCount'].forEach(id => {
            $(id).addEventListener('input', updateSimulatorDisplays);
        });
        $('simulateBtn').addEventListener('click', runSimulation);

        createLegacyInputs();
        switchMode('perps');
        updateSimulatorDisplays();
        $('out').innerHTML = `<div class="text-sm muted">시뮬레이터 또는 상세 모드에 값을 입력하고 계산 버튼을 눌러주세요.</div>`;
    });
  </script>
</body>
</html>
