<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Basedapp Simulator & Analyzer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <style>
    :root{
      color-scheme: dark light;
      --bg:#0e0f12; --panel:#16181d; --border:#242833;
      --muted:#98a2af; --accent:#ff6a-3d; --ok:#2ad7a3; --danger:#ff6b6b;
      --ring: 0 0 0 3px rgba(255,106,61,.35);
    }
    body{ background:var(--bg); color:#e8eaee }
    .card{ background:var(--panel); border:1px solid var(--border); }
    .muted{ color:var(--muted) }
    .btn-accent{ background:var(--accent); color:white }
    .btn-accent:hover{ filter:brightness(1.05) }
    input,select{
      background:#101217; border:1px solid var(--border); color:#e8eaee;
      border-radius:12px; padding:.65rem .8rem; width:100%;
    }
    input:focus,select:focus{ outline:none; box-shadow:var(--ring); border-color:#3a414b }
    .num{ font-variant-numeric:tabular-nums }
    .kv{ display:flex; gap:.5rem; align-items:baseline }
    .kv .k{ min-width:10.5rem; color:#aab2bd }
    .kv .v{ font-weight:700 }
    .text-ok{ color:var(--ok) }
    .text-danger{ color:var(--danger) }
    .tab{ padding: .5rem 1rem; border-bottom: 2px solid transparent; color: var(--muted); cursor: pointer; transition: color .2s, border-color .2s; }
    .tab.active{ color: var(--accent); border-bottom-color: var(--accent); font-weight: 600; }
  </style>
</head>
<body class="pb-28">
  <header class="max-w-5xl mx-auto px-4 py-7">
    <div class="rounded-3xl border border-[var(--accent)]/60 p-3 mx-auto w-fit">
      <div class="rounded-2xl px-5 py-3 bg-[var(--panel)] text-center">
        <h1 class="text-2xl font-semibold">Basedapp Simulator & Analyzer</h1>
      </div>
    </div>
  </header>

  <main class="max-w-5xl mx-auto px-4 space-y-6">
    <section class="card rounded-2xl p-4 space-y-4">
      <div class="flex border-b border-[var(--border)]">
        <button id="tabSimulator" class="tab active">목표 시뮬레이터</button>
        <button id="tabAnalyzer" class="tab">거래 분석</button>
      </div>
      
      <div id="simulatorInputs" class="space-y-4 pt-4">
        <p class="text-sm muted">목표 XP를 달성하기 위한 거래량과 횟수를 계산합니다.</p>
        <div class="grid lg:grid-cols-2 gap-x-6 gap-y-4">
            <div class="space-y-4">
                <label class="block"><span class="block text-xs muted">목표 XP</span><input id="targetXp" type="number" step="100" placeholder="50000"></label>
            </div>
            <div class="space-y-4">
                <label class="block"><span class="block text-xs muted">거래 방식</span><select id="simMode"><option value="perps">선물 (Perps)</option><option value="spot">현물 (Spot)</option></select></label>
                <label class="block"><span class="block text-xs muted">XP 부스트</span><select id="simBoost"><option value="0">0%</option><option value="25">25%</option><option value="50">50%</option><option value="60" selected>60%</option></select></label>
            </div>
        </div>
        <div class="grid lg:grid-cols-2 gap-x-6 gap-y-4 pt-4 border-t border-[var(--border)]">
            <label class="block"><span class="block text-xs muted">시작 자금 ($)</span><input id="simStartCapital" type="number" step="0.01" placeholder="1000"></label>
            <div id="simLeverageWrapper"><label class="block"><span class="block text-xs muted">레버리지</span><input id="simLeverage" type="number" value="10" step="1"></label></div>
        </div>
        <button id="simulateBtn" class="w-full btn-accent p-2 rounded-xl font-semibold mt-2">시뮬레이션 실행</button>
      </div>

      <div id="analyzerInputs" class="hidden space-y-4 pt-4">
        <p class="text-sm muted">실제 거래 후 누적된 거래량을 입력하여 효율을 분석합니다.</p>
        <div class="grid lg:grid-cols-2 gap-x-6 gap-y-4">
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-3">
                    <label class="block"><span class="block text-xs muted">이전 거래량 (누적, $)</span><input id="prevVol" type="number" step="0.01"></label>
                    <label class="block"><span class="block text-xs muted">현재 거래량 (누적, $)</span><input id="currVol" type="number" step="0.01"></label>
                </div>
            </div>
            <div class="space-y-4">
                <label class="block"><span class="block text-xs muted">거래 방식</span><select id="checkMode"><option value="perps">선물 (Perps)</option><option value="spot">현물 (Spot)</option></select></label>
                <label class="block"><span class="block text-xs muted">XP 부스트</span><select id="checkBoost"><option value="0">0%</option><option value="25">25%</option><option value="50">50%</option><option value="60" selected>60%</option></select></label>
            </div>
        </div>
        <button id="analyzeBtn" class="w-full btn-accent p-2 rounded-xl font-semibold mt-2">분석하기</button>
      </div>
    </section>

    <section id="resultCard" class="card rounded-2xl p-4">
        <div class="flex items-center justify-between">
            <h3 class="font-semibold text-lg">결과</h3>
            <div class="flex gap-2">
              <button id="copyBtn" class="btn-ghost px-3 py-1.5 rounded-lg text-sm">복사</button>
              <button id="pngBtn" class="btn-ghost px-3 py-1.5 rounded-lg text-sm">PNG 저장</button>
            </div>
        </div>
        <div id="out" class="space-y-2 mt-3"></div>
    </section>
  </main>
  
  <footer class="mt-6 py-4 border-t border-[var(--border)] text-center text-sm text-[var(--muted)]">
    2025 Brought to you by
    <a href="https://twitter.com/no_gongju" target="_blank" rel="noopener"
       class="ml-1 text-[var(--accent)] hover:underline">@no_gongju</a>
  </footer>

  <script>
    const FEES = { 
        perps: { total_maker: 0.0004 },
        spot:  { total_maker_avg: 0.0009 }
    };
    const BUILDER_FEE_RATES = {
        perps: 0.00025,
        spot: 0.0005 
    };
    const XP_PER_DOLLAR_BASE = {
        perps: 0.03375,
        spot: 0.3038 
    };

    const $ = (id) => document.getElementById(id);
    const d2 = (n) => Number(n || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    const d_auto = (n) => Number(n || 0).toLocaleString(undefined, { maximumFractionDigits: 4 });
    let lastResultForExport = null;

    function runSimulation() {
        const params = {
            targetXp: Number($('targetXp').value || 0),
            mode: $('simMode').value,
            boost: Number($('simBoost').value || 0),
            startCapital: Number($('simStartCapital').value || 0),
            leverage: $('simMode').value === 'perps' ? Number($('simLeverage').value || 1) : 1
        };
        if (params.targetXp <= 0) { $('out').innerHTML = `<div class="text-sm muted">목표 XP를 입력해주세요.</div>`; return; }
        
        const baseXP_rate = XP_PER_DOLLAR_BASE[params.mode];
        const boostedXP_rate = baseXP_rate * (1 + params.boost / 100);
        const neededVol = boostedXP_rate > 0 ? params.targetXp / boostedXP_rate : 0;
        
        let tradeCountText = "—";
        if (params.startCapital > 0 && params.leverage > 0) {
            const positionSize = params.startCapital * params.leverage;
            tradeCountText = positionSize > 0 ? `${d2(neededVol / positionSize)} 회` : "—";
        }
        
        const { html, data } = generateResultHTML({ ...params, type: 'sim', neededVol, tradeCountText });
        $('out').innerHTML = html;
        lastResultForExport = data;
    }

    function runAnalyzer() {
        const params = {
            usedVol: Math.max(0, Number($("currVol").value || 0) - Number($("prevVol").value || 0)),
            mode: $('checkMode').value,
            boost: Number($('checkBoost').value || 0)
        };
        if (params.usedVol <= 0) { $('out').innerHTML = `<div class="text-sm muted">이전/현재 거래량을 입력해주세요.</div>`; return; }
        
        const { html, data } = generateResultHTML({ ...params, type: 'analyzer' });
        $('out').innerHTML = html;
        lastResultForExport = data;
    }

    function generateResultHTML(p) {
        const baseXP_rate = XP_PER_DOLLAR_BASE[p.mode];
        const xp = p.type === 'sim' ? p.targetXp : p.usedVol * baseXP_rate * (1 + p.boost / 100);
        const volume = p.type === 'sim' ? p.neededVol : p.usedVol;

        const totalFeePaid = volume * (p.mode === 'perps' ? FEES.perps.total_maker : FEES.spot.total_maker_avg);
        const builderFeePaid = volume * BUILDER_FEE_RATES[p.mode];
        const hyperliquidFeePaid = totalFeePaid - builderFeePaid;
        const rebateAmt = builderFeePaid * 0.60;
        const netFeePaid = totalFeePaid - rebateAmt;
        const costPerXp = xp > 0 ? (netFeePaid / xp) : 0;
        const volPerXp = xp > 0 ? (volume / xp) : 0;

        let rows;
        if (p.type === 'sim') {
            rows = [
                `<div class="kv text-lg"><span class="k">목표 XP</span><span class="v num text-ok">${d2(p.targetXp)} XP</span></div>`,
                `<hr class="my-2 border-[#2b2f36]" />`,
                `<div class="kv"><span class="k">필요 총 거래량</span><span class="v num">${d2(volume)} $</span></div>`,
                `<div class="kv"><span class="k">필요 거래 횟수</span><span class="v num">${p.tradeCountText}</span></div>`,
                `<hr class="my-2 border-[#2b2f36]" />`,
                `<h4 class="text-sm muted font-semibold pt-2">예상 수수료 상세</h4>`,
                `<div class="kv"><span class="k">총 수수료 (하이퍼리퀴드+빌더)</span><span class="v num">${d2(totalFeePaid)} $</span></div>`,
                `<div class="kv ml-4"><span class="k text-xs">└ 하이퍼리퀴드 수수료</span><span class="v num text-xs">${d2(hyperliquidFeePaid)} $</span></div>`,
                `<div class="kv ml-4"><span class="k text-xs">└ 빌더 수수료</span><span class="v num text-xs">${d2(builderFeePaid)} $</span></div>`,
                `<div class="kv"><span class="k">리베이트 (빌더피의 60%)</span><span class="v num text-ok">${d2(rebateAmt)} $</span></div>`,
                `<div class="kv"><span class="k">최종 지불 수수료</span><span class="v num text-danger">${d2(netFeePaid)} $</span></div>`
            ];
        } else {
            const summaryCard = `
                <div class="card rounded-xl p-3 bg-[#101217] border border-[var(--border)] space-y-2 mb-4">
                    <div class="kv text-lg"><span class="k">총 획득 XP</span><span class="v num text-ok">${d2(xp)} XP</span></div>
                    <div class="kv"><span class="k">총 실질 비용</span><span class="v num text-danger">${d2(netFeePaid)} $</span></div>
                    <div class="kv"><span class="k">1 XP당 비용</span><span class="v num text-danger">${d_auto(costPerXp)} $</span></div>
                </div>`;
            const detailRows = [
                `<h4 class="text-sm muted font-semibold pt-2">거래 분석 상세</h4>`,
                `<div class="kv"><span class="k">사용 거래량</span><span class="v num">${d2(volume)} $</span></div>`,
                `<div class="kv"><span class="k">1 XP당 필요 거래량</span><span class="v num">${d_auto(volPerXp)} $</span></div>`,
                `<hr class="my-2 border-[#2b2f36]" />`,
                `<h4 class="text-sm muted font-semibold pt-2">수수료 상세</h4>`,
                `<div class="kv"><span class="k">총 수수료 (하이퍼리퀴드+빌더)</span><span class="v num">${d2(totalFeePaid)} $</span></div>`,
                `<div class="kv ml-4"><span class="k text-xs">└ 하이퍼리퀴드 수수료</span><span class="v num text-xs">${d2(hyperliquidFeePaid)} $</span></div>`,
                `<div class="kv ml-4"><span class="k text-xs">└ 빌더 수수료</span><span class="v num text-xs">${d2(builderFeePaid)} $</span></div>`,
                `<div class="kv"><span class="k">리베이트 (빌더피의 60%)</span><span class="v num text-ok">${d2(rebateAmt)} $</span></div>`,
                `<div class="kv"><span class="k">최종 지불 수수료</span><span class="v num text-danger">${d2(netFeePaid)} $</span></div>`
            ];
            return { html: summaryCard + `<div class="space-y-1">${detailRows.join("")}</div>`, data: {xp, netFeePaid, volume, totalFeePaid, rebateAmt} };
        }
        return { html: `<div class="space-y-1">${rows.join("")}</div>`, data: {xp, netFeePaid, volume, totalFeePaid, rebateAmt} };
    }
    
    // ... (이하 copy, png, save/load 등 부가 기능 함수 필요) ...

    document.addEventListener('DOMContentLoaded', () => {
        // ... (기존 이벤트 리스너) ...
    });
  </script>
</body>
</html>
