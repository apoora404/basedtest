<!doctype html>
<html lang="ko" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Basedapp Simulator & Analyzer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <style>
    :root {
      color-scheme: dark;
      --bg: #0e0f12; --panel: #16181d; --panel-solid:#121419; --border: #242833;
      --text-main: #e8eaee; --text-muted: #98a2af;
      --accent: #ff6a3d; --ok: #2ad7a3; --danger: #ff6b6b;
      --ring: 0 0 0 3px rgba(255,106,61,.35);
      --input-bg: #101217;
    }
    [data-theme='light'] {
      color-scheme: light;
      --bg: #f0f2f5; --panel: #ffffff; --border: #dcdfe3;
      --text-main: #1f2328; --text-muted: #656d76;
      --accent: #f56565; --ok: #38a169; --danger: #e53e3e;
      --ring: 0 0 0 3px rgba(245,101,101,.35);
      --input-bg: #f0f2f5;
    }
    body{ background: var(--bg); color: var(--text-main); transition: background .2s, color .2s; }
    .card{ background: var(--panel); border: 1px solid var(--border); }
    .muted{ color: var(--text-muted); }
    .btn-accent{ background: var(--accent); color: white; }
    .btn-accent:hover{ filter: brightness(1.05); }
    .btn-ghost{ background:var(--input-bg); border:1px solid var(--border); color:var(--text-main); }
    input,select{
      background: var(--input-bg); border: 1px solid var(--border); color: var(--text-main);
      border-radius: 12px; padding: .65rem .8rem; width: 100%;
    }
    input[type="radio"]{ width:auto; margin-right: 0.5rem; }
    input:focus,select:focus{ outline: none; box-shadow: var(--ring); border-color: var(--accent); }
    .num{ font-variant-numeric: tabular-nums; }
    .kv{ display: flex; gap: .5rem; align-items: baseline; }
    .kv .k{ min-width: 10.5rem; color: var(--text-muted); }
    .kv .v{ font-weight: 700; }
    .badge{ background:var(--input-bg); border:1px solid var(--border); padding:.18rem .55rem; border-radius:999px; }
    .text-ok{ color: var(--ok); }
    .text-danger{ color: var(--danger); }
    .tab{ padding: .5rem 1rem; border-bottom: 2px solid transparent; color: var(--text-muted); cursor: pointer; transition: color .2s, border-color .2s; }
    .tab.active{ color: var(--accent); border-bottom-color: var(--accent); font-weight: 600; }
  </style>
</head>
<body class="pb-28">
  <header class="max-w-5xl mx-auto px-4 py-7 relative">
    <div class="rounded-3xl border border-[var(--accent)]/60 p-3 mx-auto w-fit">
      <div class="rounded-2xl px-5 py-3 bg-[var(--panel)] text-center">
        <h1 class="text-2xl font-semibold">Basedapp Simulator & Analyzer</h1>
      </div>
    </div>
    <button id="theme-toggle" class="absolute top-8 right-8 p-2 rounded-full bg-[var(--panel)] border border-[var(--border)]">
      <svg id="theme-icon-light" class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.706-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm-.707 7.072l.707-.707a1 1 0 10-1.414-1.414l-.707.707a1 1 0 101.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" fill-rule="evenodd" clip-rule="evenodd"></path></svg>
      <svg id="theme-icon-dark" class="w-6 h-6 hidden" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
    </button>
  </header>

  <main class="max-w-5xl mx-auto px-4 space-y-6">
    <section class="card rounded-2xl p-4 space-y-4">
      <div class="flex border-b border-[var(--border)]">
        <button id="tabSimulator" class="tab active">목표 시뮬레이터</button>
        <button id="tabAnalyzer" class="tab">거래 분석</button>
      </div>
      
      <div id="simulatorInputs" class="space-y-4 pt-4">
        </div>

      <div id="analyzerInputs" class="hidden space-y-4 pt-4">
        </div>
    </section>

    <section id="resultCard" class="card rounded-2xl p-4">
        <div class="flex items-center justify-between pb-2 border-b border-[var(--border)]">
            <div class="flex items-center gap-2">
                <h3 class="font-semibold text-lg">결과</h3>
                <span id="resultBadge" class="badge text-xs"></span>
            </div>
            <div class="flex gap-2">
              <button id="copyBtn" class="btn-ghost px-3 py-1.5 rounded-lg text-sm">복사</button>
              <button id="pngBtn" class="btn-ghost px-3 py-1.5 rounded-lg text-sm">PNG 저장</button>
            </div>
        </div>
        <div id="out" class="space-y-2 mt-3"></div>
    </section>
  </main>
  
  <footer class="mt-6 py-4 border-t border-[var(--border)] text-center text-sm text-[var(--muted)]">
    2025 Brought to you by
    <a href="https://twitter.com/no_gongju" target="_blank" rel="noopener"
       class="ml-1 text-[var(--accent)] hover:underline">@no_gongju</a>
  </footer>

  <script>
    const FEES = {
        perps: [
            { name: "Tier 0", taker: 0.00045, maker: 0.00015 }, { name: "Tier 1", taker: 0.00040, maker: 0.00012 },
            { name: "Tier 2", taker: 0.00035, maker: 0.00008 }, { name: "Tier 3", taker: 0.00030, maker: 0.00004 },
            { name: "Tier 4", taker: 0.00028, maker: 0.00000 }, { name: "Tier 5", taker: 0.00026, maker: 0.00000 },
            { name: "Tier 6", taker: 0.00024, maker: 0.00000 }
        ],
        spot: [
            { name: "Tier 0", taker: 0.00070, maker: 0.00040 }, { name: "Tier 1", taker: 0.00060, maker: 0.00030 },
            { name: "Tier 2", taker: 0.00050, maker: 0.00020 }, { name: "Tier 3", taker: 0.00040, maker: 0.00010 },
            { name: "Tier 4", taker: 0.00035, maker: 0.00000 }, { name: "Tier 5", taker: 0.00030, maker: 0.00000 },
            { name: "Tier 6", taker: 0.00025, maker: 0.00000 }
        ]
    };
    const XP_PER_DOLLAR_BASE = {
        perps: 0.02525,
        spot_normal: 0.101,
        spot_pup: 0.22725
    };

    const $ = (id) => document.getElementById(id);
    const d2 = (n) => Number(n || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    const d_auto = (n) => Number(n || 0).toLocaleString(undefined, { maximumFractionDigits: 4 });
    let lastResultForExport = null;
    
    function getBaseXpRate(mode, spotType) {
        if (mode === 'perps') return XP_PER_DOLLAR_BASE.perps;
        return spotType === 'pup' ? XP_PER_DOLLAR_BASE.spot_pup : XP_PER_DOLLAR_BASE.spot_normal;
    }
    
    function populateTiers(mode, tierElementId) {
        const tierSelect = $(tierElementId);
        tierSelect.innerHTML = '';
        if (FEES[mode]) {
            FEES[mode].forEach((t, i) => {
                tierSelect.innerHTML += `<option value="${i}">${t.name}</option>`;
            });
        }
    }

    function runSimulation() {
        const params = {
            type: 'sim',
            targetXp: Number($('targetXp').value || 0),
            mode: $('simMode').value,
            spotType: document.querySelector('input[name="simSpotType"]:checked').value,
            boost: Number($('simBoost').value || 0),
            startCapital: Number($('simStartCapital').value || 0),
            leverage: $('simMode').value === 'perps' ? Number($('simLeverage').value || 1) : 1,
            orderType: document.querySelector('input[name="simOrderType"]:checked').value,
            tier: Number($('simTier').value || 0)
        };
        if (params.targetXp <= 0) { $('out').innerHTML = `<div class="text-sm muted">목표 XP를 입력해주세요.</div>`; return; }
        
        const baseXP_rate = getBaseXpRate(params.mode, params.spotType);
        const boostedXP_rate = baseXP_rate * (1 + params.boost / 100);
        params.neededVol = boostedXP_rate > 0 ? params.targetXp / boostedXP_rate : 0;
        
        if (params.startCapital > 0 && params.leverage > 0) {
            const positionSize = params.startCapital * params.leverage;
            params.tradeCountText = positionSize > 0 ? `${d2(params.neededVol / positionSize)} 회` : "—";
        } else {
            params.tradeCountText = "—";
        }
        
        generateResultHTML(params);
    }

    function runAnalyzer() {
        const params = {
            type: 'analyzer',
            usedVol: Math.max(0, Number($("currVol").value || 0) - Number($("prevVol").value || 0)),
            mode: $('checkMode').value,
            spotType: document.querySelector('input[name="checkSpotType"]:checked').value,
            boost: Number($('checkBoost').value || 0),
            orderType: document.querySelector('input[name="checkOrderType"]:checked').value,
            tier: Number($('checkTier').value || 0)
        };
        if (params.usedVol <= 0) { $('out').innerHTML = `<div class="text-sm muted">이전/현재 거래량을 입력해주세요.</div>`; return; }
        
        generateResultHTML(params);
    }
    
    function generateResultHTML(p) {
        const volume = p.type === 'sim' ? p.neededVol : p.usedVol;
        const xp = p.type === 'sim' ? p.targetXp : p.usedVol * getBaseXpRate(p.mode, p.spotType) * (1 + p.boost / 100);

        const feeRateData = FEES[p.mode][p.tier];
        const feeRate = feeRateData ? feeRateData[p.orderType] : 0;
        
        const totalFeePaid = volume * feeRate;
        const builderFeePaid = 0; // Simplified
        const hyperliquidFeePaid = totalFeePaid;
        const rebateAmt = 0;
        const netFeePaid = totalFeePaid;
        
        lastResultForExport = { ...p, volume, xp, netFeePaid, totalFeePaid, rebateAmt, tierName: feeRateData.name };
        updateResultHeader(lastResultForExport);
        
        let rowsHtml;
        if (p.type === 'sim') {
            const rows = [
                `<div class="kv text-lg"><span class="k">목표 XP</span><span class="v num text-ok">${d2(p.targetXp)} XP</span></div>`,
                `<hr class="my-2 border-[var(--border)]" />`,
                `<div class="kv"><span class="k">필요 총 거래량</span><span class="v num">${d2(p.neededVol)} $</span></div>`,
                `<div class="kv"><span class="k">필요 거래 횟수</span><span class="v num">${p.tradeCountText}</span></div>`,
                `<hr class="my-2 border-[var(--border)]" />`,
                `<h4 class="text-sm muted font-semibold pt-2">예상 수수료 상세 (${p.orderType === 'maker' ? '지정가' : '시장가'})</h4>`,
                `<div class="kv"><span class="k">총 수수료</span><span class="v num">${d2(p.totalFeePaid)} $</span></div>`,
                `<div class="kv"><span class="k">최종 지불 수수료</span><span class="v num text-danger">${d2(p.netFeePaid)} $</span></div>`
            ];
            rowsHtml = rows.join("");
        } else {
            const costPerXp = xp > 0 ? (netFeePaid / xp) : 0;
            const volPerXp = xp > 0 ? (volume / xp) : 0;
            const summaryCard = `
                <div class="card rounded-xl p-3 bg-[#101217] border-[var(--border)] space-y-2 mb-4">
                    <div class="kv text-lg"><span class="k">총 획득 XP</span><span class="v num text-ok">${d2(xp)} XP</span></div>
                    <div class="kv"><span class="k">총 실질 비용</span><span class="v num text-danger">${d2(netFeePaid)} $</span></div>
                    <div class="kv"><span class="k">1 XP당 비용</span><span class="v num text-danger">${d_auto(costPerXp)} $</span></div>
                </div>`;
            const detailRows = [
                `<h4 class="text-sm muted font-semibold pt-2">거래 분석 상세</h4>`,
                `<div class="kv"><span class="k">사용 거래량</span><span class="v num">${d2(volume)} $</span></div>`,
                `<div class="kv"><span class="k">1 XP당 필요 거래량</span><span class="v num">${d_auto(volPerXp)} $</span></div>`,
            ];
            rowsHtml = summaryCard + detailRows.join("");
        }
        $('out').innerHTML = `<div class="space-y-1">${rowsHtml}</div>`;
    }

    function updateResultHeader(params){
        const modeText = params.mode === 'perps' ? '선물' : `현물(${params.spotType==='pup' ? 'PUP' : '일반'})`;
        const orderText = params.orderType === 'maker' ? '지정가' : '시장가';
        $('resultBadge').textContent = `${modeText} | ${params.tierName} | ${params.boost}% 부스트 | ${orderText}`;
    }
    
    function switchTab(tabName) {
        const isSim = tabName === 'simulator';
        $('tabSimulator').classList.toggle('active', isSim);
        $('tabAnalyzer').classList.toggle('active', !isSim);
        $('simulatorInputs').classList.toggle('hidden', !isSim);
        $('analyzerInputs').classList.toggle('hidden', isSim);
        $('out').innerHTML = '';
        lastResultForExport = null;
    }
    
    function toggleLeverage() { $('simLeverageWrapper').style.display = $('simMode').value === 'perps' ? 'block' : 'none'; }
    function togglePupSelector() {
        $('simPupSelector').style.display = $('simMode').value === 'spot' ? 'block' : 'none';
        $('checkPupSelector').style.display = $('checkMode').value === 'spot' ? 'block' : 'none';
    }
    
    function copyResultToClipboard(){
        if (!lastResultForExport) return;
        const p = lastResultForExport;
        const text = p.type === 'sim' 
            ? `[시뮬레이터 결과]\n- 목표 XP: ${d2(p.targetXp)}\n- 필요 거래량: $${d2(p.neededVol)}\n- 최종 비용: $${d2(p.netFeePaid)}`
            : `[거래 분석 결과]\n- 획득 XP: ${d2(p.xp)}\n- 사용 거래량: $${d2(p.volume)}\n- 최종 비용: $${d2(p.netFeePaid)}`;
        navigator.clipboard.writeText(text).then(() => {
            const btn = $('copyBtn');
            const originalText = btn.textContent;
            btn.textContent = '복사됨 ✅';
            setTimeout(() => { btn.textContent = originalText; }, 1200);
        });
    }
    async function saveResultAsPng(){
        const resultNode = $('resultCard');
        if (!resultNode || !lastResultForExport) return;
        try {
            const canvas = await html2canvas(resultNode, {
                backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--bg').trim(),
                scale: 2,
                useCORS: true,
            });
            const link = document.createElement('a');
            link.href = canvas.toDataURL('image/png');
            link.download = 'basedapp_result.png';
            link.click();
            const btn = $('pngBtn');
            const originalText = btn.textContent;
            btn.textContent = '저장됨 ✅';
            setTimeout(() => { btn.textContent = originalText; }, 1200);
        } catch (error) { console.error('PNG 저장 오류:', error); }
    }

    const themeToggle = $('theme-toggle');
    const lightIcon = $('theme-icon-light');
    const darkIcon = $('theme-icon-dark');
    const docEl = document.documentElement;

    function applyTheme(theme) {
        docEl.setAttribute('data-theme', theme);
        lightIcon.classList.toggle('hidden', theme === 'light');
        darkIcon.classList.toggle('hidden', theme === 'dark');
    }

    function toggleTheme() {
        const newTheme = docEl.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
        localStorage.setItem('theme', newTheme);
        applyTheme(newTheme);
    }

    document.addEventListener('DOMContentLoaded', () => {
        populateTiers('perps', 'simTier');
        populateTiers('perps', 'checkTier');
        toggleLeverage();
        togglePupSelector();
        
        $('tabSimulator').addEventListener('click', () => switchTab('simulator'));
        $('tabAnalyzer').addEventListener('click', () => switchTab('analyzer'));
        
        $('simulateBtn').addEventListener('click', runSimulation);
        $('analyzeBtn').addEventListener('click', runAnalyzer);
        
        $('simMode').addEventListener('change', () => {
            populateTiers($('simMode').value, 'simTier');
            toggleLeverage(); 
            togglePupSelector(); 
        });
        $('checkMode').addEventListener('change', () => {
            populateTiers($('checkMode').value, 'checkTier');
            togglePupSelector();
        });

        themeToggle.addEventListener('click', toggleTheme);
        $('copyBtn').addEventListener('click', copyResultToClipboard);
        $('pngBtn').addEventListener('click', saveResultAsPng);
        
        const savedTheme = localStorage.getItem('theme') || 'dark';
        applyTheme(savedTheme);
        
        $('out').innerHTML = `<div class="text-sm muted">원하는 작업을 선택하고 값을 입력해주세요.</div>`;
    });
  </script>
</body>
</html>
